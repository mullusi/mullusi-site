<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ፊደል | Mfidel Symbolic Audio Atlas</title>
    <style>
        :root {
            --void: #0a0a0f;
            --deep: #12121a;
            --surface: #1a1a25;
            --elevated: #242433;
            --gold: #d4a574;
            --gold-dim: rgba(212, 165, 116, 0.3);
            --amber: #f59e0b;
            --emerald: #10b981;
            --cyan: #06b6d4;
            --violet: #8b5cf6;
            --rose: #f43f5e;
            --white: #f5f5f5;
            --muted: rgba(255,255,255,0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--void);
            color: var(--white);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--deep) 0%, var(--surface) 100%);
            border-bottom: 1px solid var(--gold-dim);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-ethiopic {
            font-size: 2.5rem;
            color: var(--gold);
        }

        .logo h1 {
            font-size: 1.4rem;
            font-weight: 400;
            color: var(--gold);
        }

        .logo-sub {
            font-size: 0.7rem;
            color: var(--muted);
        }

        .stats-bar {
            display: flex;
            gap: 30px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            color: var(--cyan);
            font-weight: 300;
        }

        .stat-label {
            font-size: 0.65rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 320px;
            height: calc(100vh - 70px);
        }

        /* Gebeta Grid */
        .gebeta-container {
            padding: 20px;
            overflow: auto;
        }

        .gebeta-title {
            font-size: 1rem;
            color: var(--gold);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .gebeta-title::before {
            content: '◈';
            color: var(--amber);
        }

        .gebeta-grid {
            display: grid;
            grid-template-columns: 50px repeat(8, 1fr);
            gap: 2px;
            background: rgba(212, 165, 116, 0.05);
            padding: 10px;
            border-radius: 8px;
            max-width: 900px;
        }

        .column-header {
            padding: 8px;
            text-align: center;
            font-size: 0.7rem;
            color: var(--amber);
            background: rgba(245, 158, 11, 0.1);
            border-radius: 4px;
        }

        .row-header {
            padding: 8px 4px;
            text-align: center;
            font-size: 0.65rem;
            color: var(--violet);
            background: rgba(139, 92, 246, 0.1);
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .row-num {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .fidel-cell {
            background: var(--surface);
            border-radius: 4px;
            padding: 8px 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .fidel-cell:hover {
            background: var(--elevated);
            transform: scale(1.05);
            z-index: 10;
        }

        .fidel-cell.selected {
            background: rgba(212, 165, 116, 0.2);
            box-shadow: 0 0 0 2px var(--gold);
        }

        .fidel-cell.vowel-row {
            background: rgba(6, 182, 212, 0.15);
        }

        .fidel-cell.exception {
            background: rgba(244, 63, 94, 0.15);
        }

        .fidel-cell.col8 {
            background: rgba(16, 185, 129, 0.15);
        }

        .fidel-symbol {
            font-size: 1.4rem;
            color: var(--white);
            line-height: 1;
        }

        .fidel-id {
            font-size: 0.5rem;
            color: var(--muted);
            margin-top: 2px;
        }

        .empty-cell {
            background: rgba(255,255,255,0.02);
        }

        /* Right Panel */
        .detail-panel {
            background: var(--deep);
            border-left: 1px solid var(--gold-dim);
            padding: 20px;
            overflow-y: auto;
        }

        .panel-section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 0.75rem;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--gold-dim);
        }

        /* Selected Fidel Display */
        .selected-fidel {
            text-align: center;
            padding: 20px;
            background: var(--surface);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .selected-symbol {
            font-size: 4rem;
            color: var(--gold);
            line-height: 1;
        }

        .selected-id {
            font-size: 0.8rem;
            color: var(--cyan);
            margin-top: 8px;
        }

        .selected-family {
            font-size: 0.7rem;
            color: var(--muted);
        }

        /* Audio Formula Display */
        .formula-box {
            background: var(--surface);
            border-radius: 6px;
            padding: 12px;
            font-family: 'Consolas', monospace;
            font-size: 0.75rem;
            margin-bottom: 10px;
        }

        .formula-label {
            color: var(--muted);
            font-size: 0.65rem;
            margin-bottom: 4px;
        }

        .formula-content {
            color: var(--emerald);
        }

        .formula-decomp {
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.5rem;
        }

        .decomp-part {
            padding: 8px 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }

        .decomp-equals {
            color: var(--gold);
        }

        .decomp-plus {
            color: var(--cyan);
        }

        .decomp-whisper {
            color: var(--violet);
        }

        .decomp-vowel {
            color: var(--amber);
        }

        /* Audio Controls */
        .audio-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .audio-btn {
            flex: 1;
            padding: 10px;
            background: var(--gold);
            border: none;
            border-radius: 6px;
            color: var(--void);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .audio-btn:hover {
            background: var(--amber);
            transform: translateY(-1px);
        }

        .audio-btn:disabled {
            background: var(--elevated);
            color: var(--muted);
            cursor: not-allowed;
        }

        /* Rules Reference */
        .rules-list {
            font-size: 0.7rem;
            color: var(--muted);
        }

        .rule-item {
            padding: 8px;
            background: var(--surface);
            border-radius: 4px;
            margin-bottom: 6px;
            border-left: 3px solid var(--gold-dim);
        }

        .rule-item.active {
            border-left-color: var(--emerald);
            background: rgba(16, 185, 129, 0.1);
        }

        .rule-title {
            color: var(--white);
            font-weight: 500;
            margin-bottom: 4px;
        }

        /* Legend */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.65rem;
            color: var(--muted);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* Word Input */
        .word-input-container {
            margin-top: 20px;
        }

        .word-input {
            width: 100%;
            padding: 12px;
            background: var(--surface);
            border: 1px solid var(--gold-dim);
            border-radius: 6px;
            color: var(--white);
            font-size: 1.2rem;
            text-align: center;
            direction: ltr;
        }

        .word-input:focus {
            outline: none;
            border-color: var(--gold);
        }

        .word-analysis {
            margin-top: 10px;
            font-size: 0.7rem;
            color: var(--muted);
            max-height: 150px;
            overflow-y: auto;
        }

        .word-fidel {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--surface);
            border-radius: 4px;
            margin: 2px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--void); }
        ::-webkit-scrollbar-thumb { background: var(--gold-dim); border-radius: 3px; }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <span class="logo-ethiopic">ፊደል</span>
            <div>
                <h1>Mfidel Symbolic Audio Atlas</h1>
                <div class="logo-sub">34 Families × 8 Forms • Atomic Symbols • Audio Synthesis</div>
            </div>
        </div>
        <div class="stats-bar">
            <div class="stat">
                <div class="stat-value">272</div>
                <div class="stat-label">Total Fidels</div>
            </div>
            <div class="stat">
                <div class="stat-value">34</div>
                <div class="stat-label">Families</div>
            </div>
            <div class="stat">
                <div class="stat-value">8</div>
                <div class="stat-label">Vowels</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="active-rules">0</div>
                <div class="stat-label">Active Rules</div>
            </div>
        </div>
    </header>

    <main class="main-container">
        <!-- Gebeta Grid -->
        <section class="gebeta-container">
            <div class="gebeta-title">ፊደል ገበታ — Fidel Gebeta (Complete Atlas)</div>
            <div class="gebeta-grid" id="gebeta-grid"></div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: rgba(6, 182, 212, 0.3)"></div>
                    <span>Vowel Row (17)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: rgba(244, 63, 94, 0.3)"></div>
                    <span>Exception (ሀ,ሐ,ዐ use አ)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: rgba(16, 185, 129, 0.3)"></div>
                    <span>8th Form (f[r][2]+ኣ)</span>
                </div>
            </div>
        </section>

        <!-- Detail Panel -->
        <aside class="detail-panel">
            <div class="selected-fidel" id="selected-display">
                <div class="selected-symbol">ለ</div>
                <div class="selected-id">f[2][1]</div>
                <div class="selected-family">la-family (ለ)</div>
            </div>

            <div class="panel-section">
                <div class="section-title">Audio Formula</div>
                <div class="formula-box">
                    <div class="formula-label">Standard Formula</div>
                    <div class="formula-content" id="formula-display">
                        f[r][c].s(w,v) = f[r][c].s(w) + f[17][c].s(w,v)
                    </div>
                </div>
                <div class="formula-decomp" id="decomp-display">
                    <span class="decomp-part decomp-whisper">ለ</span>
                    <span class="decomp-equals">=</span>
                    <span class="decomp-part decomp-whisper">ለ</span>
                    <span class="decomp-plus">+</span>
                    <span class="decomp-part decomp-vowel">ኧ</span>
                </div>
            </div>

            <div class="audio-controls">
                <button class="audio-btn" id="btn-play-whisper">▶ Whisper</button>
                <button class="audio-btn" id="btn-play-full">▶ Full Sound</button>
            </div>

            <div class="panel-section">
                <div class="section-title">Applied Rules</div>
                <div class="rules-list" id="rules-list">
                    <div class="rule-item active">
                        <div class="rule-title">Standard Formula</div>
                        <div>f[r][c].s(w,v) = f[r][c].s(w) + f[17][c].s(w,v)</div>
                    </div>
                    <div class="rule-item">
                        <div class="rule-title">8th Column Rule</div>
                        <div>f[r][8] = f[r][2].w + f[17][4].v</div>
                    </div>
                    <div class="rule-item">
                        <div class="rule-title">ሀ/ሐ/ዐ Exception</div>
                        <div>Column 1 uses አ instead of ኧ</div>
                    </div>
                </div>
            </div>

            <div class="panel-section word-input-container">
                <div class="section-title">Word Analyzer</div>
                <input type="text" class="word-input" id="word-input" placeholder="ለአማርኛ" value="ኢትዮጵያ">
                <div class="word-analysis" id="word-analysis"></div>
            </div>
        </aside>
    </main>

    <script>
    // =========================================================================
    // MFIDEL ATLAS DATA
    // =========================================================================

    const VOWELS = {
        1: { symbol: 'ኧ', phonetic: 'ə' },
        2: { symbol: 'ኡ', phonetic: 'u' },
        3: { symbol: 'ኢ', phonetic: 'i' },
        4: { symbol: 'ኣ', phonetic: 'a' },
        5: { symbol: 'ኤ', phonetic: 'e' },
        6: { symbol: 'እ', phonetic: 'ɨ' },
        7: { symbol: 'ኦ', phonetic: 'o' },
        8: { symbol: 'አ', phonetic: 'ʔa' }
    };

    const FIDEL_GEBETA = {
        1:  { name: 'ha', base: 'h', exception: true, fidels: ['ሀ','ሁ','ሂ','ሃ','ሄ','ህ','ሆ','ሇ'] },
        2:  { name: 'la', base: 'l', fidels: ['ለ','ሉ','ሊ','ላ','ሌ','ል','ሎ','ሏ'] },
        3:  { name: 'ħa', base: 'ħ', exception: true, fidels: ['ሐ','ሑ','ሒ','ሓ','ሔ','ሕ','ሖ','ሗ'] },
        4:  { name: 'ma', base: 'm', fidels: ['መ','ሙ','ሚ','ማ','ሜ','ም','ሞ','ሟ'] },
        5:  { name: 'śa', base: 'ś', fidels: ['ሠ','ሡ','ሢ','ሣ','ሤ','ሥ','ሦ','ሧ'] },
        6:  { name: 'ra', base: 'r', fidels: ['ረ','ሩ','ሪ','ራ','ሬ','ር','ሮ','ሯ'] },
        7:  { name: 'sa', base: 's', fidels: ['ሰ','ሱ','ሲ','ሳ','ሴ','ስ','ሶ','ሷ'] },
        8:  { name: 'ša', base: 'ʃ', fidels: ['ሸ','ሹ','ሺ','ሻ','ሼ','ሽ','ሾ','ሿ'] },
        9:  { name: 'qa', base: 'q', fidels: ['ቀ','ቁ','ቂ','ቃ','ቄ','ቅ','ቆ','ቋ'] },
        10: { name: 'ba', base: 'b', fidels: ['በ','ቡ','ቢ','ባ','ቤ','ብ','ቦ','ቧ'] },
        11: { name: 'va', base: 'v', fidels: ['ቨ','ቩ','ቪ','ቫ','ቬ','ቭ','ቮ','ቯ'] },
        12: { name: 'ta', base: 't', fidels: ['ተ','ቱ','ቲ','ታ','ቴ','ት','ቶ','ቷ'] },
        13: { name: 'ča', base: 'tʃ', fidels: ['ቸ','ቹ','ቺ','ቻ','ቼ','ች','ቾ','ቿ'] },
        14: { name: 'xa', base: 'x', fidels: ['ኀ','ኁ','ኂ','ኃ','ኄ','ኅ','ኆ','ኈ'] },
        15: { name: 'na', base: 'n', fidels: ['ነ','ኑ','ኒ','ና','ኔ','ን','ኖ','ኗ'] },
        16: { name: 'ña', base: 'ɲ', fidels: ['ኘ','ኙ','ኚ','ኛ','ኜ','ኝ','ኞ','ኟ'] },
        17: { name: 'vowel', base: 'ʔ', isVowel: true, fidels: ['ኧ','ኡ','ኢ','ኣ','ኤ','እ','ኦ','አ'] },
        18: { name: 'ka', base: 'k', fidels: ['ከ','ኩ','ኪ','ካ','ኬ','ክ','ኮ','ኳ'] },
        19: { name: 'xa', base: 'x', fidels: ['ኸ','ኹ','ኺ','ኻ','ኼ','ኽ','ኾ','ዃ'] },
        20: { name: 'wa', base: 'w', cols: 7, fidels: ['ወ','ዉ','ዊ','ዋ','ዌ','ው','ዎ'] },
        21: { name: 'ʕa', base: 'ʕ', cols: 7, exception: true, fidels: ['ዐ','ዑ','ዒ','ዓ','ዔ','ዕ','ዖ'] },
        22: { name: 'za', base: 'z', fidels: ['ዘ','ዙ','ዚ','ዛ','ዜ','ዝ','ዞ','ዟ'] },
        23: { name: 'ža', base: 'ʒ', fidels: ['ዠ','ዡ','ዢ','ዣ','ዤ','ዥ','ዦ','ዧ'] },
        24: { name: 'ya', base: 'j', cols: 7, fidels: ['የ','ዩ','ዪ','ያ','ዬ','ይ','ዮ'] },
        25: { name: 'da', base: 'd', fidels: ['ደ','ዱ','ዲ','ዳ','ዴ','ድ','ዶ','ዷ'] },
        26: { name: 'ǧa', base: 'dʒ', fidels: ['ጀ','ጁ','ጂ','ጃ','ጄ','ጅ','ጆ','ጇ'] },
        27: { name: 'ga', base: 'g', fidels: ['ገ','ጉ','ጊ','ጋ','ጌ','ግ','ጎ','ጓ'] },
        28: { name: "t'a", base: "tʼ", fidels: ['ጠ','ጡ','ጢ','ጣ','ጤ','ጥ','ጦ','ጧ'] },
        29: { name: "č'a", base: "tʃʼ", fidels: ['ጨ','ጩ','ጪ','ጫ','ጬ','ጭ','ጮ','ጯ'] },
        30: { name: "p'a", base: "pʼ", fidels: ['ጰ','ጱ','ጲ','ጳ','ጴ','ጵ','ጶ','ጷ'] },
        31: { name: "s'a", base: "sʼ", fidels: ['ጸ','ጹ','ጺ','ጻ','ጼ','ጽ','ጾ','ጿ'] },
        32: { name: "ts'a", base: "tsʼ", fidels: ['ፀ','ፁ','ፂ','ፃ','ፄ','ፅ','ፆ','ፇ'] },
        33: { name: 'fa', base: 'f', fidels: ['ፈ','ፉ','ፊ','ፋ','ፌ','ፍ','ፎ','ፏ'] },
        34: { name: 'pa', base: 'p', fidels: ['ፐ','ፑ','ፒ','ፓ','ፔ','ፕ','ፖ','ፗ'] }
    };

    // Build reverse lookup
    const symbolToCoord = new Map();
    for (let r = 1; r <= 34; r++) {
        const row = FIDEL_GEBETA[r];
        for (let c = 0; c < row.fidels.length; c++) {
            symbolToCoord.set(row.fidels[c], { row: r, col: c + 1 });
        }
    }

    // =========================================================================
    // AUDIO ENGINE
    // =========================================================================

    let audioCtx = null;

    const whisperFreq = {
        'h': 200, 'l': 350, 'ħ': 180, 'm': 250, 'ś': 4500, 'r': 1500,
        's': 4000, 'ʃ': 3500, 'q': 150, 'b': 120, 'v': 200, 't': 3000,
        'tʃ': 3200, 'x': 2000, 'n': 280, 'ɲ': 300, 'ʔ': 100, 'k': 2500,
        'w': 400, 'ʕ': 150, 'z': 250, 'ʒ': 280, 'j': 300, 'd': 150,
        'dʒ': 200, 'g': 180, 'tʼ': 3000, 'tʃʼ': 3200, 'pʼ': 2800,
        'sʼ': 4200, 'tsʼ': 4000, 'f': 3500, 'p': 2500
    };

    const vowelFormants = {
        1: { f1: 500, f2: 1500 },
        2: { f1: 300, f2: 870 },
        3: { f1: 270, f2: 2290 },
        4: { f1: 730, f2: 1090 },
        5: { f1: 400, f2: 2000 },
        6: { f1: 400, f2: 1600 },
        7: { f1: 570, f2: 840 },
        8: { f1: 730, f2: 1090 }
    };

    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        return audioCtx;
    }

    function playFidel(row, col, whisperOnly = false) {
        const ctx = initAudio();
        const rowData = FIDEL_GEBETA[row];
        const baseFreq = whisperFreq[rowData.base] || 200;
        
        // Determine vowel column
        let vowelCol = col;
        if (col === 8 && (rowData.cols || 8) === 8) {
            vowelCol = 4; // 8th form uses ኣ
        }
        if (col === 1 && rowData.exception) {
            vowelCol = 8; // Exception uses አ
        }
        
        const formants = vowelFormants[vowelCol];
        const duration = 0.3;
        const now = ctx.currentTime;

        // Whisper oscillator
        const whisperOsc = ctx.createOscillator();
        const whisperGain = ctx.createGain();
        whisperOsc.type = 'sawtooth';
        whisperOsc.frequency.value = baseFreq;
        whisperGain.gain.value = 0.15;
        whisperOsc.connect(whisperGain);

        // Vowel oscillators (if not whisper only)
        const masterGain = ctx.createGain();
        whisperGain.connect(masterGain);

        if (!whisperOnly) {
            const vowelOsc1 = ctx.createOscillator();
            const vowelOsc2 = ctx.createOscillator();
            const vowelGain = ctx.createGain();
            
            vowelOsc1.type = 'sine';
            vowelOsc1.frequency.value = formants.f1;
            vowelOsc2.type = 'sine';
            vowelOsc2.frequency.value = formants.f2;
            vowelGain.gain.value = 0.3;
            
            vowelOsc1.connect(vowelGain);
            vowelOsc2.connect(vowelGain);
            vowelGain.connect(masterGain);
            
            vowelOsc1.start(now);
            vowelOsc2.start(now);
            vowelOsc1.stop(now + duration);
            vowelOsc2.stop(now + duration);
        }

        masterGain.connect(ctx.destination);
        masterGain.gain.setValueAtTime(0, now);
        masterGain.gain.linearRampToValueAtTime(0.5, now + 0.02);
        masterGain.gain.linearRampToValueAtTime(0.3, now + duration * 0.5);
        masterGain.gain.linearRampToValueAtTime(0, now + duration);

        whisperOsc.start(now);
        whisperOsc.stop(now + duration);
    }

    // =========================================================================
    // FORMULA COMPUTATION
    // =========================================================================

    function computeFormula(row, col) {
        const rowData = FIDEL_GEBETA[row];
        const maxCols = rowData.cols || 8;
        
        let shapeRow = row;
        let shapeCol = col;
        let vowelCol = col;
        let rules = ['standard'];

        // 8th column rule
        if (col === 8 && maxCols === 8) {
            shapeCol = 2;
            vowelCol = 4;
            rules = ['col8'];
        }

        // Exception rule for rows 1, 3, 21
        if (col === 1 && rowData.exception) {
            vowelCol = 8;
            rules = ['exception'];
        }

        // Special: vowel row col 8
        if (row === 17 && col === 8) {
            return {
                shape: 'ኧ',
                shapeId: 'f[17][1]',
                vowel: 'ኣ',
                vowelId: 'f[17][4]',
                formula: 'f[17][8].s(w,v) = f[17][1].s(w) + f[17][4].s(w,v)',
                rules: ['vowel8']
            };
        }

        const shape = FIDEL_GEBETA[shapeRow].fidels[shapeCol - 1];
        const vowel = VOWELS[vowelCol].symbol;

        return {
            shape,
            shapeId: `f[${shapeRow}][${shapeCol}]`,
            vowel,
            vowelId: `f[17][${vowelCol}]`,
            formula: `f[${row}][${col}].s(w,v) = f[${shapeRow}][${shapeCol}].s(w) + f[17][${vowelCol}].s(w,v)`,
            rules
        };
    }

    // =========================================================================
    // UI RENDERING
    // =========================================================================

    let selectedFidel = { row: 2, col: 1 };

    function buildGebetaGrid() {
        const grid = document.getElementById('gebeta-grid');
        grid.innerHTML = '';

        // Header row
        grid.appendChild(createEl('div', 'column-header', ''));
        for (let c = 1; c <= 8; c++) {
            const vowel = VOWELS[c];
            grid.appendChild(createEl('div', 'column-header', `${c}: ${vowel.symbol}`));
        }

        // Data rows
        for (let r = 1; r <= 34; r++) {
            const rowData = FIDEL_GEBETA[r];
            const maxCols = rowData.cols || 8;

            // Row header
            const header = createEl('div', 'row-header', '');
            header.innerHTML = `<span class="row-num">${r}</span><span>${rowData.name}</span>`;
            grid.appendChild(header);

            // Fidel cells
            for (let c = 1; c <= 8; c++) {
                if (c > maxCols) {
                    grid.appendChild(createEl('div', 'fidel-cell empty-cell', ''));
                    continue;
                }

                const cell = document.createElement('div');
                cell.className = 'fidel-cell';
                
                // Add special classes
                if (r === 17) cell.classList.add('vowel-row');
                if (c === 1 && rowData.exception) cell.classList.add('exception');
                if (c === 8 && maxCols === 8 && r !== 17) cell.classList.add('col8');
                if (r === selectedFidel.row && c === selectedFidel.col) {
                    cell.classList.add('selected');
                }

                cell.innerHTML = `
                    <div class="fidel-symbol">${rowData.fidels[c - 1]}</div>
                    <div class="fidel-id">f[${r}][${c}]</div>
                `;

                cell.addEventListener('click', () => selectFidel(r, c));
                grid.appendChild(cell);
            }
        }
    }

    function createEl(tag, className, text) {
        const el = document.createElement(tag);
        el.className = className;
        el.textContent = text;
        return el;
    }

    function selectFidel(row, col) {
        selectedFidel = { row, col };
        
        // Update grid selection
        document.querySelectorAll('.fidel-cell.selected').forEach(el => {
            el.classList.remove('selected');
        });
        
        const cells = document.querySelectorAll('.fidel-cell:not(.empty-cell)');
        let idx = 0;
        for (let r = 1; r <= 34; r++) {
            const maxCols = FIDEL_GEBETA[r].cols || 8;
            for (let c = 1; c <= 8; c++) {
                if (c <= maxCols) {
                    if (r === row && c === col) {
                        cells[idx].classList.add('selected');
                    }
                    idx++;
                }
            }
        }

        updateDetailPanel();
    }

    function updateDetailPanel() {
        const { row, col } = selectedFidel;
        const rowData = FIDEL_GEBETA[row];
        const fidel = rowData.fidels[col - 1];
        const formula = computeFormula(row, col);

        // Selected display
        document.querySelector('.selected-symbol').textContent = fidel;
        document.querySelector('.selected-id').textContent = `f[${row}][${col}]`;
        document.querySelector('.selected-family').textContent = `${rowData.name}-family`;

        // Formula
        document.getElementById('formula-display').textContent = formula.formula;

        // Decomposition
        document.getElementById('decomp-display').innerHTML = `
            <span class="decomp-part">${fidel}</span>
            <span class="decomp-equals">=</span>
            <span class="decomp-part decomp-whisper">${formula.shape}</span>
            <span class="decomp-plus">+</span>
            <span class="decomp-part decomp-vowel">${formula.vowel}</span>
        `;

        // Rules
        const rulesEl = document.getElementById('rules-list');
        rulesEl.querySelectorAll('.rule-item').forEach(el => {
            el.classList.remove('active');
        });
        
        if (formula.rules.includes('standard')) {
            rulesEl.children[0].classList.add('active');
        }
        if (formula.rules.includes('col8')) {
            rulesEl.children[1].classList.add('active');
        }
        if (formula.rules.includes('exception') || formula.rules.includes('vowel8')) {
            rulesEl.children[2].classList.add('active');
        }

        // Active rules count
        document.getElementById('active-rules').textContent = formula.rules.length;
    }

    function analyzeWord() {
        const word = document.getElementById('word-input').value;
        const analysisEl = document.getElementById('word-analysis');
        let html = '';

        for (const char of word) {
            const coord = symbolToCoord.get(char);
            if (coord) {
                const formula = computeFormula(coord.row, coord.col);
                html += `<div class="word-fidel">
                    <span style="font-size: 1.2rem; color: var(--gold)">${char}</span>
                    <span style="color: var(--muted)">=</span>
                    <span style="color: var(--violet)">${formula.shape}</span>
                    <span style="color: var(--cyan)">+</span>
                    <span style="color: var(--amber)">${formula.vowel}</span>
                </div>`;
            }
        }

        analysisEl.innerHTML = html || '<em>Enter Amharic text above</em>';
    }

    // =========================================================================
    // EVENT LISTENERS
    // =========================================================================

    document.getElementById('btn-play-whisper').addEventListener('click', () => {
        playFidel(selectedFidel.row, selectedFidel.col, true);
    });

    document.getElementById('btn-play-full').addEventListener('click', () => {
        playFidel(selectedFidel.row, selectedFidel.col, false);
    });

    document.getElementById('word-input').addEventListener('input', analyzeWord);

    // =========================================================================
    // INITIALIZATION
    // =========================================================================

    buildGebetaGrid();
    updateDetailPanel();
    analyzeWord();

    console.log('Mfidel Symbolic Audio Atlas initialized');
    console.log('Total fidels:', Array.from(symbolToCoord.keys()).length);
    </script>
</body>
</html>
