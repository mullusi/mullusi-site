<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="VIRECAI v5.2 - Symbolic Causal Video Intelligence Platform">
    <title>VIRECAI v5.2 | Symbolic Causal Intelligence</title>
    
    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CSS DESIGN SYSTEM v5.2 - Mobile-First Responsive
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        :root {
            /* Color Palette */
            --bg-100: #05050a;
            --bg-200: #0a0a0f;
            --bg-300: #0f0f16;
            --bg-400: #14141d;
            --bg-500: #1a1a25;
            --bg-600: #22222f;
            --bg-700: #2a2a3a;
            
            --primary: #00d4ff;
            --primary-dark: #00a8cc;
            --primary-light: #4de4ff;
            --primary-alpha: rgba(0, 212, 255, 0.15);
            
            --secondary: #7b61ff;
            --success: #00ff88;
            --success-alpha: rgba(0, 255, 136, 0.15);
            --warning: #ffaa00;
            --warning-alpha: rgba(255, 170, 0, 0.15);
            --danger: #ff4466;
            --danger-alpha: rgba(255, 68, 102, 0.15);
            
            --text-100: #ffffff;
            --text-200: #e0e0e8;
            --text-300: #a0a0b0;
            --text-400: #707080;
            
            --border-100: #3a3a4a;
            --border-200: #2a2a3a;
            
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
            --glow-primary: 0 0 20px rgba(0, 212, 255, 0.4);
            --glow-danger: 0 0 20px rgba(255, 68, 102, 0.5);
            
            /* Spacing */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            
            /* Mobile-first sizing */
            --header-height: 48px;
            --controls-height: 72px;
            --bottom-nav-height: 56px;
            
            /* Safe areas for notched phones */
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
        }
        
        /* Reset */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -webkit-text-size-adjust: 100%;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-200);
            color: var(--text-100);
            min-height: 100vh;
            min-height: 100dvh; /* Dynamic viewport height for mobile */
            overflow: hidden;
            touch-action: manipulation;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: var(--bg-400); }
        ::-webkit-scrollbar-thumb { background: var(--border-100); border-radius: 4px; }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MOBILE-FIRST LAYOUT
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .app {
            display: flex;
            flex-direction: column;
            height: 100%;
            height: 100dvh;
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
            background: var(--bg-100);
        }
        
        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-2) var(--space-3);
            background: var(--bg-300);
            border-bottom: 1px solid var(--border-200);
            height: var(--header-height);
            flex-shrink: 0;
            z-index: 100;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .logo__icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            box-shadow: var(--glow-primary);
        }
        
        .logo__text {
            font-size: 16px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--text-100), var(--text-300));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .logo__version {
            font-size: 10px;
            color: var(--text-400);
            padding: 2px 4px;
            background: var(--bg-500);
            border-radius: 4px;
        }
        
        .header__controls {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }
        
        .status-dot--recording {
            background: var(--danger);
            box-shadow: 0 0 8px var(--danger);
            animation: pulse 1.2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.3); }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MAIN VIEWPORT - Fullscreen camera
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .main {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            background: #000;
            overflow: hidden;
        }
        
        .viewport {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            overflow: hidden;
        }
        
        .viewport__video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Mirror for front camera */
        .viewport__video--mirrored {
            transform: scaleX(-1);
        }
        
        .viewport--recording {
            box-shadow: inset 0 0 0 3px var(--danger);
        }
        
        /* Camera loading/error states */
        .viewport__placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-300);
            color: var(--text-300);
            gap: var(--space-4);
            z-index: 5;
        }
        
        .viewport__placeholder.hidden {
            display: none;
        }
        
        .viewport__placeholder-icon {
            font-size: 48px;
            opacity: 0.5;
        }
        
        .viewport__placeholder-text {
            font-size: 14px;
            text-align: center;
            max-width: 280px;
        }
        
        .viewport__placeholder-btn {
            padding: var(--space-3) var(--space-5);
            background: var(--primary);
            color: var(--bg-100);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Detection overlay */
        .viewport__overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 10;
        }
        
        .detection-box {
            position: absolute;
            border: 2px solid var(--primary);
            border-radius: 4px;
            background: var(--primary-alpha);
        }
        
        .detection-box__label {
            position: absolute;
            top: -22px;
            left: 0;
            padding: 2px 6px;
            background: var(--primary);
            color: var(--bg-100);
            font-size: 11px;
            font-weight: 600;
            border-radius: 4px;
            white-space: nowrap;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           FLOATING CONTROLS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .controls {
            position: absolute;
            bottom: var(--space-4);
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-2) var(--space-3);
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 40px;
            border: 1px solid var(--border-200);
            z-index: 20;
        }
        
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn--icon {
            width: 44px;
            height: 44px;
            background: var(--bg-500);
            border: 1px solid var(--border-200);
            border-radius: 50%;
            color: var(--text-100);
            font-size: 18px;
        }
        
        .btn--icon:active {
            transform: scale(0.95);
            background: var(--bg-600);
        }
        
        .btn--record {
            width: 60px;
            height: 60px;
            background: var(--danger);
            border: 3px solid var(--text-100);
            border-radius: 50%;
            box-shadow: var(--glow-danger);
        }
        
        .btn--record:active {
            transform: scale(0.95);
        }
        
        .btn--record.recording {
            border-radius: 12px;
            background: var(--text-100);
        }
        
        .btn--record.recording::after {
            content: '';
            width: 22px;
            height: 22px;
            background: var(--danger);
            border-radius: 4px;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           FLOATING INFO PANELS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .info-panel {
            position: absolute;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 12px;
            border: 1px solid var(--border-200);
            padding: var(--space-3);
            z-index: 15;
            max-width: 160px;
        }
        
        .info-panel--top-left {
            top: var(--space-3);
            left: var(--space-3);
        }
        
        .info-panel--top-right {
            top: var(--space-3);
            right: var(--space-3);
        }
        
        .info-panel--bottom-left {
            bottom: calc(var(--controls-height) + var(--space-4));
            left: var(--space-3);
        }
        
        .info-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-400);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }
        
        .info-value {
            font-size: 20px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }
        
        .info-unit {
            font-size: 12px;
            font-weight: 400;
            color: var(--text-300);
        }
        
        .info-trend {
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 2px;
        }
        
        .info-trend--up { color: var(--success); }
        .info-trend--down { color: var(--danger); }
        .info-trend--stable { color: var(--text-400); }
        
        /* Mini chart */
        .mini-chart {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 20px;
            margin-top: var(--space-2);
        }
        
        .mini-chart__bar {
            flex: 1;
            background: var(--primary);
            border-radius: 1px;
            min-height: 2px;
        }
        
        /* Emotion display */
        .emotion-display {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .emotion-emoji {
            font-size: 24px;
        }
        
        .emotion-label {
            font-size: 14px;
            font-weight: 600;
            text-transform: capitalize;
        }
        
        /* Time display */
        .time-display {
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            text-shadow: var(--glow-primary);
        }
        
        .frame-count {
            font-size: 11px;
            color: var(--text-400);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           BOTTOM NAVIGATION (Mobile)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .bottom-nav {
            display: flex;
            background: var(--bg-300);
            border-top: 1px solid var(--border-200);
            height: var(--bottom-nav-height);
            flex-shrink: 0;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            background: transparent;
            border: none;
            color: var(--text-400);
            font-size: 10px;
            cursor: pointer;
            transition: color 0.15s ease;
        }
        
        .nav-item--active {
            color: var(--primary);
        }
        
        .nav-item__icon {
            font-size: 20px;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SLIDE-UP PANELS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .panel-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .panel-overlay--active {
            opacity: 1;
            visibility: visible;
        }
        
        .slide-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-300);
            border-radius: 20px 20px 0 0;
            max-height: 70vh;
            max-height: 70dvh;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 201;
            display: flex;
            flex-direction: column;
            padding-bottom: var(--safe-bottom);
        }
        
        .panel-overlay--active .slide-panel {
            transform: translateY(0);
        }
        
        .panel__handle {
            width: 40px;
            height: 4px;
            background: var(--border-100);
            border-radius: 2px;
            margin: var(--space-3) auto;
            flex-shrink: 0;
        }
        
        .panel__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-4) var(--space-3);
            border-bottom: 1px solid var(--border-200);
            flex-shrink: 0;
        }
        
        .panel__title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .panel__close {
            width: 32px;
            height: 32px;
            background: var(--bg-500);
            border: none;
            border-radius: 50%;
            color: var(--text-300);
            font-size: 18px;
            cursor: pointer;
        }
        
        .panel__content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-4);
        }
        
        /* Sensors Grid */
        .sensors-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-3);
        }
        
        .sensor-card {
            background: var(--bg-400);
            border: 1px solid var(--border-200);
            border-radius: 12px;
            padding: var(--space-3);
        }
        
        .sensor-card--warning {
            border-color: var(--warning);
            background: var(--warning-alpha);
        }
        
        .sensor-card__label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-400);
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        .sensor-card__value {
            font-size: 22px;
            font-weight: 700;
            line-height: 1.2;
        }
        
        .sensor-card__unit {
            font-size: 12px;
            font-weight: 400;
            color: var(--text-300);
        }
        
        /* LLM Panel */
        .llm-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: var(--space-3);
        }
        
        .llm-message {
            background: var(--bg-400);
            border-radius: 12px;
            padding: var(--space-3);
            margin-bottom: var(--space-2);
            font-size: 14px;
            line-height: 1.5;
        }
        
        .llm-message strong {
            color: var(--primary);
        }
        
        .llm-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
            margin-top: var(--space-3);
        }
        
        .llm-suggestion {
            padding: var(--space-1) var(--space-3);
            background: var(--bg-500);
            border: 1px solid var(--border-200);
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-200);
            cursor: pointer;
        }
        
        .llm-suggestion:active {
            background: var(--primary-alpha);
            border-color: var(--primary);
        }
        
        .llm-input-row {
            display: flex;
            gap: var(--space-2);
        }
        
        .llm-input {
            flex: 1;
            background: var(--bg-400);
            border: 1px solid var(--border-200);
            border-radius: 12px;
            padding: var(--space-3);
            color: var(--text-100);
            font-size: 14px;
        }
        
        .llm-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .llm-send {
            width: 44px;
            height: 44px;
            background: var(--primary);
            border: none;
            border-radius: 12px;
            color: var(--bg-100);
            font-size: 18px;
            cursor: pointer;
        }
        
        /* Layers Panel */
        .layer-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--bg-400);
            border: 1px solid var(--border-200);
            border-radius: 12px;
            margin-bottom: var(--space-2);
        }
        
        .layer-item--active {
            border-color: var(--success);
            background: var(--success-alpha);
        }
        
        .layer-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .layer-info {
            flex: 1;
        }
        
        .layer-name {
            font-size: 14px;
            font-weight: 500;
        }
        
        .layer-toggle {
            width: 44px;
            height: 24px;
            background: var(--bg-600);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
        }
        
        .layer-toggle::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.15s ease;
        }
        
        .layer-item--active .layer-toggle {
            background: var(--success);
        }
        
        .layer-item--active .layer-toggle::after {
            transform: translateX(20px);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TOAST NOTIFICATIONS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .toast-container {
            position: fixed;
            top: calc(var(--safe-top) + var(--header-height) + var(--space-3));
            left: var(--space-3);
            right: var(--space-3);
            z-index: 300;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            pointer-events: none;
        }
        
        .toast {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            background: var(--bg-400);
            border: 1px solid var(--border-200);
            border-radius: 12px;
            font-size: 14px;
            animation: toastIn 0.3s ease;
            pointer-events: auto;
        }
        
        .toast--success { border-left: 3px solid var(--success); }
        .toast--warning { border-left: 3px solid var(--warning); }
        .toast--error { border-left: 3px solid var(--danger); }
        .toast--info { border-left: 3px solid var(--primary); }
        
        .toast--exit { animation: toastOut 0.2s ease forwards; }
        
        @keyframes toastIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes toastOut {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(-20px); opacity: 0; }
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           WH-CHAIN BADGES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .wh-chain {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-1);
            margin-top: var(--space-3);
        }
        
        .wh-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .wh-badge--who { background: rgba(123, 97, 255, 0.2); color: var(--secondary); }
        .wh-badge--what { background: var(--primary-alpha); color: var(--primary); }
        .wh-badge--when { background: var(--warning-alpha); color: var(--warning); }
        .wh-badge--where { background: var(--success-alpha); color: var(--success); }
        .wh-badge--why { background: var(--danger-alpha); color: var(--danger); }
        .wh-badge--how { background: rgba(0, 188, 212, 0.2); color: #00bcd4; }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           DESKTOP OVERRIDES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @media (min-width: 768px) {
            :root {
                --header-height: 56px;
            }
            
            .bottom-nav {
                display: none;
            }
            
            .main {
                padding-bottom: 0;
            }
            
            /* Show sidebar on desktop */
            .app {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .header {
                width: 100%;
            }
            
            .main {
                flex: 1;
                min-width: 0;
            }
            
            .desktop-sidebar {
                display: flex;
                flex-direction: column;
                width: 320px;
                background: var(--bg-300);
                border-left: 1px solid var(--border-200);
            }
            
            .desktop-sidebar__tabs {
                display: flex;
                border-bottom: 1px solid var(--border-200);
            }
            
            .desktop-sidebar__tab {
                flex: 1;
                padding: var(--space-3);
                background: transparent;
                border: none;
                border-bottom: 2px solid transparent;
                color: var(--text-300);
                font-size: 13px;
                cursor: pointer;
            }
            
            .desktop-sidebar__tab--active {
                color: var(--primary);
                border-bottom-color: var(--primary);
            }
            
            .desktop-sidebar__content {
                flex: 1;
                overflow-y: auto;
                padding: var(--space-4);
            }
            
            .info-panel {
                max-width: 180px;
            }
        }
        
        @media (max-width: 767px) {
            .desktop-sidebar {
                display: none;
            }
        }
        
        /* Landscape mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .info-panel {
                padding: var(--space-2);
            }
            
            .info-value {
                font-size: 16px;
            }
            
            .controls {
                bottom: var(--space-2);
            }
            
            .btn--record {
                width: 48px;
                height: 48px;
            }
            
            .btn--icon {
                width: 36px;
                height: 36px;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Panel Overlays -->
    <div class="panel-overlay" id="sensorsOverlay">
        <div class="slide-panel">
            <div class="panel__handle"></div>
            <div class="panel__header">
                <h2 class="panel__title">ğŸ“Š Sensors</h2>
                <button class="panel__close" onclick="closePanel('sensors')">Ã—</button>
            </div>
            <div class="panel__content">
                <div class="sensors-grid">
                    <div class="sensor-card" id="hrCard">
                        <div class="sensor-card__label">Heart Rate</div>
                        <div class="sensor-card__value"><span id="hrValue">--</span><span class="sensor-card__unit"> BPM</span></div>
                        <div class="info-trend info-trend--stable" id="hrTrend">â†’ stable</div>
                        <div class="mini-chart" id="hrChart"></div>
                    </div>
                    <div class="sensor-card" id="stressCard">
                        <div class="sensor-card__label">Stress Level</div>
                        <div class="sensor-card__value"><span id="stressValue">--</span><span class="sensor-card__unit">%</span></div>
                        <div class="info-trend info-trend--stable" id="stressTrend">â†’ stable</div>
                        <div class="mini-chart" id="stressChart"></div>
                    </div>
                    <div class="sensor-card">
                        <div class="sensor-card__label">Skin Temp</div>
                        <div class="sensor-card__value"><span id="tempValue">--</span><span class="sensor-card__unit">Â°C</span></div>
                    </div>
                    <div class="sensor-card">
                        <div class="sensor-card__label">Emotion</div>
                        <div class="emotion-display">
                            <span class="emotion-emoji" id="emotionEmoji">ğŸ˜</span>
                            <span class="emotion-label" id="emotionLabel">neutral</span>
                        </div>
                    </div>
                    <div class="sensor-card">
                        <div class="sensor-card__label">Objects</div>
                        <div class="sensor-card__value"><span id="objectCount">0</span></div>
                        <div style="font-size:11px;color:var(--text-400);margin-top:4px" id="objectList">No detections</div>
                    </div>
                    <div class="sensor-card">
                        <div class="sensor-card__label">Scene</div>
                        <div class="sensor-card__value" style="font-size:14px" id="sceneValue">--</div>
                    </div>
                </div>
                
                <div style="margin-top:var(--space-4)">
                    <div class="sensor-card">
                        <div class="sensor-card__label">WH-Chain</div>
                        <div class="wh-chain" id="whChainDisplay">
                            <span class="wh-badge wh-badge--what">WHAT: waiting</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top:var(--space-3)">
                    <div class="sensor-card">
                        <div class="sensor-card__label">Causal Graph</div>
                        <div class="sensor-card__value" style="font-size:14px">
                            <span id="causalNodes">0</span> nodes Â· <span id="causalEdges">0</span> edges
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="panel-overlay" id="llmOverlay">
        <div class="slide-panel">
            <div class="panel__handle"></div>
            <div class="panel__header">
                <h2 class="panel__title">ğŸ’¬ Mirror LLM</h2>
                <button class="panel__close" onclick="closePanel('llm')">Ã—</button>
            </div>
            <div class="panel__content" style="display:flex;flex-direction:column">
                <div class="llm-messages" id="llmMessages">
                    <div class="llm-message">
                        <strong>ğŸ§  Mirror LLM v5.2 Ready</strong><br><br>
                        Ask me about the scene using WH questions:
                        <div class="llm-suggestions">
                            <span class="llm-suggestion" onclick="askLLM('What is happening?')">What's happening?</span>
                            <span class="llm-suggestion" onclick="askLLM('How is the mood?')">How's the mood?</span>
                            <span class="llm-suggestion" onclick="askLLM('Who is here?')">Who is here?</span>
                            <span class="llm-suggestion" onclick="askLLM('Why did it change?')">Why?</span>
                        </div>
                    </div>
                </div>
                <div class="llm-input-row">
                    <input type="text" class="llm-input" id="llmInput" placeholder="Ask about the scene..." />
                    <button class="llm-send" onclick="submitLLM()">â¤</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="panel-overlay" id="layersOverlay">
        <div class="slide-panel">
            <div class="panel__handle"></div>
            <div class="panel__header">
                <h2 class="panel__title">ğŸšï¸ Layers</h2>
                <button class="panel__close" onclick="closePanel('layers')">Ã—</button>
            </div>
            <div class="panel__content" id="layersList"></div>
        </div>
    </div>
    
    <!-- Main App -->
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo__icon">V</div>
                <span class="logo__text">VIRECAI</span>
                <span class="logo__version">v5.2</span>
            </div>
            <div class="header__controls">
                <select id="profileSelect" style="background:var(--bg-500);border:1px solid var(--border-200);border-radius:6px;padding:4px 8px;color:var(--text-100);font-size:12px">
                    <option value="lite">Lite</option>
                    <option value="standard" selected>Standard</option>
                    <option value="extended">Extended</option>
                    <option value="ultra">Ultra</option>
                </select>
                <div class="status-dot" id="statusDot"></div>
            </div>
        </header>
        
        <!-- Main Viewport -->
        <main class="main">
            <div class="viewport" id="viewport">
                <video class="viewport__video" id="video" autoplay playsinline muted></video>
                
                <div class="viewport__placeholder" id="placeholder">
                    <div class="viewport__placeholder-icon">ğŸ“·</div>
                    <div class="viewport__placeholder-text" id="placeholderText">Tap to enable camera</div>
                    <button class="viewport__placeholder-btn" id="enableCameraBtn" onclick="requestCamera()">Enable Camera</button>
                </div>
                
                <div class="viewport__overlay" id="overlay"></div>
                
                <!-- Floating Info Panels -->
                <div class="info-panel info-panel--top-left">
                    <div class="time-display" id="timeDisplay">0:00</div>
                    <div class="frame-count">Frame: <span id="frameCount">0</span></div>
                </div>
                
                <div class="info-panel info-panel--top-right" id="hrPanel">
                    <div class="info-label">Heart Rate</div>
                    <div class="info-value"><span id="hrValueFloat">--</span><span class="info-unit"> BPM</span></div>
                    <div class="mini-chart" id="hrChartFloat"></div>
                </div>
                
                <div class="info-panel info-panel--bottom-left" id="emotionPanel">
                    <div class="emotion-display">
                        <span class="emotion-emoji" id="emotionEmojiFloat">ğŸ˜</span>
                        <span class="emotion-label" id="emotionLabelFloat">neutral</span>
                    </div>
                </div>
                
                <!-- Controls -->
                <div class="controls">
                    <button class="btn btn--icon" onclick="switchCamera()" title="Switch Camera">ğŸ”„</button>
                    <button class="btn btn--record" id="recordBtn" onclick="toggleRecording()"></button>
                    <button class="btn btn--icon" onclick="exportCapsule()" title="Export">ğŸ’¾</button>
                </div>
            </div>
        </main>
        
        <!-- Desktop Sidebar -->
        <aside class="desktop-sidebar">
            <div class="desktop-sidebar__tabs">
                <button class="desktop-sidebar__tab desktop-sidebar__tab--active" data-tab="sensors">ğŸ“Š Sensors</button>
                <button class="desktop-sidebar__tab" data-tab="llm">ğŸ’¬ LLM</button>
                <button class="desktop-sidebar__tab" data-tab="layers">ğŸšï¸ Layers</button>
            </div>
            <div class="desktop-sidebar__content" id="desktopSidebarContent">
                <!-- Content injected by JS -->
            </div>
        </aside>
        
        <!-- Bottom Navigation (Mobile) -->
        <nav class="bottom-nav">
            <button class="nav-item nav-item--active" onclick="openPanel('sensors')">
                <span class="nav-item__icon">ğŸ“Š</span>
                <span>Sensors</span>
            </button>
            <button class="nav-item" onclick="openPanel('llm')">
                <span class="nav-item__icon">ğŸ’¬</span>
                <span>LLM</span>
            </button>
            <button class="nav-item" onclick="openPanel('layers')">
                <span class="nav-item__icon">ğŸšï¸</span>
                <span>Layers</span>
            </button>
            <button class="nav-item" onclick="showSettings()">
                <span class="nav-item__icon">âš™ï¸</span>
                <span>Settings</span>
            </button>
        </nav>
    </div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VIRECAI v5.2 - Mobile-Optimized with Android Camera Fix
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const VERSION = '5.2.0';
        
        // Detect platform
        const isAndroid = /Android/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isMobile = isAndroid || isIOS;
        
        console.log(`%cVIRECAI v${VERSION}`, 'color:#00d4ff;font-size:20px;font-weight:bold');
        console.log(`Platform: ${isAndroid ? 'Android' : isIOS ? 'iOS' : 'Desktop'}`);
        
        // Layer definitions
        const LAYERS = {
            visual: { icon: 'ğŸ¬', name: 'Visual', color: '#00d4ff' },
            audio: { icon: 'ğŸ”Š', name: 'Audio', color: '#7b61ff' },
            depth: { icon: 'ğŸ“', name: 'Depth', color: '#00ff88' },
            object: { icon: 'ğŸ¯', name: 'Object', color: '#ffaa00' },
            face: { icon: 'ğŸ‘¤', name: 'Face', color: '#4ecdc4' },
            pose: { icon: 'ğŸƒ', name: 'Pose', color: '#f7dc6f' },
            emotional: { icon: 'ğŸ˜Š', name: 'Emotion', color: '#ff69b4' },
            biometric: { icon: 'ğŸ’“', name: 'Biometric', color: '#e74c3c' },
            geopose: { icon: 'ğŸ“', name: 'GeoPose', color: '#3498db' },
            temporal: { icon: 'â±ï¸', name: 'Temporal', color: '#9b59b6' },
            causal: { icon: 'ğŸ”—', name: 'Causal', color: '#1abc9c' },
            semantic: { icon: 'ğŸ·ï¸', name: 'Semantic', color: '#2ecc71' }
        };
        
        const PROFILES = {
            lite: ['visual', 'audio', 'object', 'temporal'],
            standard: ['visual', 'audio', 'depth', 'object', 'emotional', 'biometric', 'geopose', 'temporal', 'causal'],
            extended: Object.keys(LAYERS),
            ultra: Object.keys(LAYERS)
        };
        
        // State
        const state = {
            isRecording: false,
            cameraReady: false,
            profile: 'standard',
            activeLayers: new Set(PROFILES.standard),
            startTime: 0,
            frameCount: 0,
            currentTime: 0,
            facingMode: 'user',
            sensors: {
                hr: 72, hrHistory: [],
                stress: 0.3, stressHistory: [],
                temp: 36.6,
                emotion: 'neutral', emotionConf: 0.8,
                objects: [],
                scene: 'indoor'
            },
            causal: { nodes: 0, edges: 0 },
            animationId: null
        };
        
        let stream = null;
        
        // DOM helpers
        const $ = id => document.getElementById(id);
        const $$ = sel => document.querySelectorAll(sel);
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TOAST SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function toast(message, type = 'info') {
            const container = $('toastContainer');
            const el = document.createElement('div');
            el.className = `toast toast--${type}`;
            el.textContent = message;
            container.appendChild(el);
            
            setTimeout(() => {
                el.classList.add('toast--exit');
                setTimeout(() => el.remove(), 200);
            }, 3000);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CAMERA SYSTEM - Android/iOS Fixed
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function requestCamera() {
            const placeholder = $('placeholder');
            const video = $('video');
            const placeholderText = $('placeholderText');
            
            placeholderText.textContent = 'Requesting camera access...';
            $('enableCameraBtn').disabled = true;
            
            try {
                // Stop any existing stream
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                // Build constraints - different for Android
                const constraints = {
                    video: {
                        facingMode: state.facingMode,
                        width: { ideal: isMobile ? 1280 : 1920 },
                        height: { ideal: isMobile ? 720 : 1080 }
                    },
                    audio: false
                };
                
                // On Android, we need to be more flexible with constraints
                if (isAndroid) {
                    // First try with exact facingMode
                    try {
                        constraints.video.facingMode = { exact: state.facingMode };
                        stream = await navigator.mediaDevices.getUserMedia(constraints);
                    } catch (e) {
                        // Fall back to ideal
                        console.log('Exact facingMode failed, trying ideal...');
                        constraints.video.facingMode = state.facingMode;
                        stream = await navigator.mediaDevices.getUserMedia(constraints);
                    }
                } else {
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                }
                
                video.srcObject = stream;
                
                // Wait for video to be ready
                await new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        video.play()
                            .then(resolve)
                            .catch(reject);
                    };
                    video.onerror = reject;
                    
                    // Timeout
                    setTimeout(() => reject(new Error('Video load timeout')), 10000);
                });
                
                // Apply mirroring for front camera
                if (state.facingMode === 'user') {
                    video.classList.add('viewport__video--mirrored');
                } else {
                    video.classList.remove('viewport__video--mirrored');
                }
                
                placeholder.classList.add('hidden');
                state.cameraReady = true;
                toast('Camera ready', 'success');
                
            } catch (error) {
                console.error('Camera error:', error);
                
                let errorMessage = 'Camera access denied';
                
                if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage = 'No camera found on this device';
                } else if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage = 'Camera permission denied. Please allow camera access in settings.';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage = 'Camera is in use by another app';
                } else if (error.name === 'OverconstrainedError') {
                    // Try again with minimal constraints
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                        video.srcObject = stream;
                        await video.play();
                        placeholder.classList.add('hidden');
                        state.cameraReady = true;
                        toast('Camera ready (fallback mode)', 'success');
                        return;
                    } catch (e) {
                        errorMessage = 'Camera configuration not supported';
                    }
                }
                
                placeholderText.textContent = errorMessage;
                $('enableCameraBtn').disabled = false;
                $('enableCameraBtn').textContent = 'Try Again';
                toast(errorMessage, 'error');
            }
        }
        
        async function switchCamera() {
            if (!state.cameraReady) {
                toast('Camera not ready', 'warning');
                return;
            }
            
            state.facingMode = state.facingMode === 'user' ? 'environment' : 'user';
            
            toast(`Switching to ${state.facingMode === 'user' ? 'front' : 'back'} camera...`, 'info');
            
            // Stop current stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            // Show placeholder briefly
            $('placeholder').classList.remove('hidden');
            $('placeholderText').textContent = 'Switching camera...';
            
            await requestCamera();
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RECORDING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function toggleRecording() {
            if (!state.cameraReady) {
                toast('Please enable camera first', 'warning');
                return;
            }
            state.isRecording ? stopRecording() : startRecording();
        }
        
        function startRecording() {
            state.isRecording = true;
            state.startTime = performance.now();
            state.frameCount = 0;
            state.causal = { nodes: 0, edges: 0 };
            
            $('recordBtn').classList.add('recording');
            $('viewport').classList.add('viewport--recording');
            $('statusDot').classList.add('status-dot--recording');
            
            toast('Recording started', 'success');
            captureLoop();
        }
        
        function stopRecording() {
            state.isRecording = false;
            cancelAnimationFrame(state.animationId);
            
            $('recordBtn').classList.remove('recording');
            $('viewport').classList.remove('viewport--recording');
            $('statusDot').classList.remove('status-dot--recording');
            
            toast(`Recorded ${state.frameCount} frames`, 'success');
        }
        
        function captureLoop() {
            if (!state.isRecording) return;
            
            const elapsed = performance.now() - state.startTime;
            state.currentTime = elapsed;
            state.frameCount++;
            
            updateSensors(elapsed);
            updatePerception();
            updateUI(elapsed);
            
            if (state.frameCount % 30 === 0) {
                state.causal.nodes++;
                if (state.sensors.hr > 85) state.causal.edges++;
            }
            
            state.animationId = requestAnimationFrame(captureLoop);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SENSOR SIMULATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function updateSensors(elapsed) {
            const t = elapsed / 1000;
            
            // Heart rate
            const hrBase = 72;
            const hrVar = Math.sin(t / 8) * 6 + Math.sin(t / 2.5) * 3 + (Math.random() - 0.5) * 4;
            state.sensors.hr = Math.round(hrBase + hrVar + state.sensors.stress * 20);
            state.sensors.hrHistory.push(state.sensors.hr);
            if (state.sensors.hrHistory.length > 20) state.sensors.hrHistory.shift();
            
            // Stress
            state.sensors.stress += (Math.random() - 0.5) * 0.015;
            state.sensors.stress = Math.max(0, Math.min(1, state.sensors.stress));
            state.sensors.stressHistory.push(state.sensors.stress);
            if (state.sensors.stressHistory.length > 20) state.sensors.stressHistory.shift();
            
            // Temperature
            state.sensors.temp = 36.6 + Math.sin(t / 20) * 0.2 + (Math.random() - 0.5) * 0.1;
            
            // Update displays
            const hrValue = state.sensors.hr;
            $('hrValue').textContent = hrValue;
            $('hrValueFloat').textContent = hrValue;
            $('stressValue').textContent = Math.round(state.sensors.stress * 100);
            $('tempValue').textContent = state.sensors.temp.toFixed(1);
            
            // Warning states
            $('hrCard')?.classList.toggle('sensor-card--warning', hrValue > 100);
            $('stressCard')?.classList.toggle('sensor-card--warning', state.sensors.stress > 0.7);
            
            // Mini charts
            renderMiniChart('hrChart', state.sensors.hrHistory, 60, 120);
            renderMiniChart('hrChartFloat', state.sensors.hrHistory, 60, 120);
            renderMiniChart('stressChart', state.sensors.stressHistory.map(s => s * 100), 0, 100);
        }
        
        function renderMiniChart(elementId, data, min, max) {
            const container = $(elementId);
            if (!container) return;
            
            container.innerHTML = '';
            const barCount = Math.min(data.length, 12);
            const subset = data.slice(-barCount);
            
            subset.forEach(val => {
                const height = ((val - min) / (max - min)) * 100;
                const bar = document.createElement('div');
                bar.className = 'mini-chart__bar';
                bar.style.height = `${Math.max(5, height)}%`;
                container.appendChild(bar);
            });
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PERCEPTION SIMULATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const OBJECTS = ['person', 'phone', 'laptop', 'cup', 'book', 'chair'];
        const EMOTIONS = ['neutral', 'joy', 'surprise', 'calm', 'focus'];
        const SCENES = ['office', 'bedroom', 'living room', 'outdoor'];
        
        const EMOTION_EMOJI = {
            neutral: 'ğŸ˜', joy: 'ğŸ˜Š', surprise: 'ğŸ˜®', calm: 'ğŸ˜Œ', focus: 'ğŸ¯'
        };
        
        function updatePerception() {
            // Objects
            if (state.frameCount % 60 === 0) {
                const count = 1 + Math.floor(Math.random() * 3);
                state.sensors.objects = [];
                
                for (let i = 0; i < count; i++) {
                    state.sensors.objects.push({
                        class: OBJECTS[Math.floor(Math.random() * OBJECTS.length)],
                        conf: 0.65 + Math.random() * 0.3,
                        x: 10 + Math.random() * 60,
                        y: 10 + Math.random() * 50,
                        w: 10 + Math.random() * 20,
                        h: 15 + Math.random() * 25
                    });
                }
                
                $('objectCount').textContent = count;
                $('objectList').textContent = state.sensors.objects.map(o => o.class).join(', ');
                renderDetectionBoxes();
            }
            
            // Emotion
            if (state.frameCount % 45 === 0) {
                state.sensors.emotion = EMOTIONS[Math.floor(Math.random() * EMOTIONS.length)];
                state.sensors.emotionConf = 0.6 + Math.random() * 0.35;
                
                const emoji = EMOTION_EMOJI[state.sensors.emotion];
                $('emotionEmoji').textContent = emoji;
                $('emotionLabel').textContent = state.sensors.emotion;
                $('emotionEmojiFloat').textContent = emoji;
                $('emotionLabelFloat').textContent = state.sensors.emotion;
            }
            
            // Scene
            if (state.frameCount % 90 === 0) {
                state.sensors.scene = SCENES[Math.floor(Math.random() * SCENES.length)];
                $('sceneValue').textContent = state.sensors.scene;
            }
            
            // Update WH chain
            updateWHChain();
        }
        
        function renderDetectionBoxes() {
            const overlay = $('overlay');
            overlay.innerHTML = '';
            
            state.sensors.objects.forEach(obj => {
                const box = document.createElement('div');
                box.className = 'detection-box';
                box.style.cssText = `left:${obj.x}%;top:${obj.y}%;width:${obj.w}%;height:${obj.h}%`;
                
                const label = document.createElement('span');
                label.className = 'detection-box__label';
                label.textContent = `${obj.class} ${Math.round(obj.conf * 100)}%`;
                box.appendChild(label);
                
                overlay.appendChild(box);
            });
        }
        
        function updateWHChain() {
            const container = $('whChainDisplay');
            if (!container) return;
            
            container.innerHTML = `
                <span class="wh-badge wh-badge--what">WHAT: ${state.sensors.emotion}</span>
                <span class="wh-badge wh-badge--where">WHERE: ${state.sensors.scene}</span>
                <span class="wh-badge wh-badge--when">WHEN: ${formatTime(state.currentTime)}</span>
                <span class="wh-badge wh-badge--how">HOW: HR ${state.sensors.hr}</span>
            `;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UI UPDATES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function updateUI(elapsed) {
            const s = Math.floor(elapsed / 1000);
            const m = Math.floor(s / 60);
            
            $('timeDisplay').textContent = `${m}:${String(s % 60).padStart(2, '0')}`;
            $('frameCount').textContent = state.frameCount;
            
            $('causalNodes').textContent = state.causal.nodes;
            $('causalEdges').textContent = state.causal.edges;
        }
        
        function formatTime(ms) {
            const s = Math.floor(ms / 1000);
            const m = Math.floor(s / 60);
            return `${m}:${String(s % 60).padStart(2, '0')}`;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PANELS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function openPanel(panel) {
            const overlay = $(`${panel}Overlay`);
            if (overlay) {
                overlay.classList.add('panel-overlay--active');
            }
        }
        
        function closePanel(panel) {
            const overlay = $(`${panel}Overlay`);
            if (overlay) {
                overlay.classList.remove('panel-overlay--active');
            }
        }
        
        // Close on backdrop click
        $$('.panel-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('panel-overlay--active');
                }
            });
        });
        
        function showSettings() {
            toast('Settings coming soon', 'info');
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LLM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function submitLLM() {
            const input = $('llmInput');
            const query = input.value.trim();
            if (!query) return;
            
            input.value = '';
            askLLM(query);
        }
        
        function askLLM(query) {
            addLLMMessage(`<strong>You:</strong> ${query}`, true);
            const response = processLLMQuery(query);
            setTimeout(() => addLLMMessage(response), 200);
        }
        
        function processLLMQuery(query) {
            const q = query.toLowerCase();
            
            if (q.includes('what') || q.includes('happening')) {
                return `<strong>ğŸ¬ Scene Analysis</strong><br><br>
                    ğŸ“ Environment: ${state.sensors.scene}<br>
                    ğŸ¯ Objects: ${state.sensors.objects.map(o => o.class).join(', ')}<br>
                    ğŸ˜Š Emotion: ${state.sensors.emotion}<br>
                    ğŸ’“ HR: ${state.sensors.hr} BPM`;
            }
            
            if (q.includes('emotion') || q.includes('mood') || q.includes('how')) {
                return `<strong>ğŸ˜Š Emotional State</strong><br><br>
                    Primary: ${state.sensors.emotion} (${Math.round(state.sensors.emotionConf * 100)}%)<br>
                    Stress: ${Math.round(state.sensors.stress * 100)}%<br>
                    HR: ${state.sensors.hr} BPM`;
            }
            
            if (q.includes('who') || q.includes('person')) {
                const people = state.sensors.objects.filter(o => o.class === 'person');
                return `<strong>ğŸ‘¤ People</strong><br><br>
                    ${people.length === 0 ? 'No people detected' : `${people.length} person(s) detected`}`;
            }
            
            if (q.includes('why')) {
                return `<strong>ğŸ”— Causal Analysis</strong><br><br>
                    Causal Graph: ${state.causal.nodes} nodes, ${state.causal.edges} edges<br>
                    ${state.sensors.hr > 85 ? 'Elevated HR â†’ emotional arousal' : 'Stable state'}`;
            }
            
            return `<strong>ğŸ§  Query</strong>: "${query}"<br><br>
                Try: What, How, Who, Why questions`;
        }
        
        function addLLMMessage(html, isUser = false) {
            const container = $('llmMessages');
            const msg = document.createElement('div');
            msg.className = 'llm-message';
            if (isUser) msg.style.background = 'var(--bg-500)';
            msg.innerHTML = html;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LAYERS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function renderLayers() {
            const container = $('layersList');
            if (!container) return;
            
            container.innerHTML = '';
            
            for (const [id, layer] of Object.entries(LAYERS)) {
                const isActive = state.activeLayers.has(id);
                
                const item = document.createElement('div');
                item.className = `layer-item ${isActive ? 'layer-item--active' : ''}`;
                item.innerHTML = `
                    <div class="layer-icon" style="background:${layer.color}22;color:${layer.color}">${layer.icon}</div>
                    <div class="layer-info">
                        <div class="layer-name">${layer.name}</div>
                    </div>
                    <div class="layer-toggle"></div>
                `;
                item.onclick = () => toggleLayer(id);
                container.appendChild(item);
            }
        }
        
        function toggleLayer(id) {
            if (state.activeLayers.has(id)) {
                state.activeLayers.delete(id);
            } else {
                state.activeLayers.add(id);
            }
            renderLayers();
            toast(`${LAYERS[id].name}: ${state.activeLayers.has(id) ? 'ON' : 'OFF'}`, 'info');
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // EXPORT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function exportCapsule() {
            const capsule = {
                id: `vrc_${Date.now().toString(36)}`,
                version: VERSION,
                profile: state.profile,
                metadata: {
                    duration: state.currentTime,
                    frameCount: state.frameCount,
                    created: Date.now()
                },
                activeLayers: Array.from(state.activeLayers),
                causal: state.causal
            };
            
            const blob = new Blob([JSON.stringify(capsule, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${capsule.id}.vrc`;
            a.click();
            
            URL.revokeObjectURL(url);
            toast('Capsule exported!', 'success');
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DESKTOP SIDEBAR
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function setupDesktopSidebar() {
            const tabs = $$('.desktop-sidebar__tab');
            const content = $('desktopSidebarContent');
            
            if (!content) return;
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('desktop-sidebar__tab--active'));
                    tab.classList.add('desktop-sidebar__tab--active');
                    
                    const tabName = tab.dataset.tab;
                    
                    // Clone content from mobile panels
                    const panel = $(`${tabName}Overlay`)?.querySelector('.panel__content');
                    if (panel) {
                        content.innerHTML = panel.innerHTML;
                    }
                });
            });
            
            // Initial load
            const sensorsContent = $('sensorsOverlay')?.querySelector('.panel__content');
            if (sensorsContent) {
                content.innerHTML = sensorsContent.innerHTML;
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PROFILE CHANGE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        $('profileSelect').addEventListener('change', (e) => {
            state.profile = e.target.value;
            state.activeLayers = new Set(PROFILES[state.profile]);
            renderLayers();
            toast(`Profile: ${state.profile}`, 'success');
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LLM INPUT ENTER KEY
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        $('llmInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') submitLLM();
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INITIALIZE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function init() {
            console.log('Initializing VIRECAI v5.2...');
            
            renderLayers();
            setupDesktopSidebar();
            
            // Auto-request camera on desktop
            if (!isMobile) {
                await requestCamera();
            }
            
            toast(`VIRECAI v${VERSION} Ready`, 'success');
        }
        
        // Handle visibility change (pause/resume)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && state.isRecording) {
                // Optionally pause on background
            }
        });
        
        // Prevent pull-to-refresh on mobile
        document.body.addEventListener('touchmove', (e) => {
            if (e.target.closest('.panel__content') || e.target.closest('.llm-messages')) {
                return;
            }
            e.preventDefault();
        }, { passive: false });
        
        init();
    </script>
</body>
</html>
